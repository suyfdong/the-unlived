# 🎯 双层限流策略说明

## 更新内容

已将限流从**单层**升级为**双层保护**，大幅提升防护效果！

### 旧策略的问题 ❌
- **每小时10次** × 24小时 = **每天240次**
- 恶意用户可以分散在全天刷接口
- 成本风险高，容易被薅羊毛

### 新策略 ✅

#### AI生成限流（双层）
1. **小时限制**: 每小时最多 **10次**（防止短时间爆刷）
2. **每日限制**: 每天最多 **20次**（防止全天薅羊毛）⭐ 核心保护

#### 展览提交限流（双层）
1. **小时限制**: 每小时最多 **20次**
2. **每日限制**: 每天最多 **30次**

## 成本对比

| 限流策略 | 每天最多请求 | 成本控制效果 |
|---------|-------------|-------------|
| ❌ 旧：仅小时限制 | 240次 | 可被分散刷 |
| ✅ 新：双层限流 | **20次** | **降低92%** |

## 环境变量配置

```bash
# AI生成（双层限流）
MAX_REQUESTS_PER_HOUR=10      # 每小时限制
MAX_REQUESTS_PER_DAY=20       # 每日总量 ⭐ 最重要

# 展览提交（双层限流）
MAX_SUBMIT_PER_HOUR=20
MAX_SUBMIT_PER_DAY=30

# 其他
MAX_TEXT_LENGTH=2000
```

## 为什么20次/天合理？

✅ **真实用户**: 写5-10封信已经是深度情感表达，20次足够
✅ **测试用户**: 前几次尝试功能完全够用
✅ **成本可控**: 相比240次/天降低92%
❌ **薅羊毛**: 无法大规模刷接口

## 工作原理

1. **先检查每日限制**
   - 如果IP今天已用完20次 → 拒绝，显示"请X小时后再试"

2. **再检查小时限制**
   - 如果IP这小时已用完10次 → 拒绝，显示"请X分钟后再试"

3. **两层都通过** → 允许请求

## 用户体验

### 正常用户
- 第1-10次：✅ 流畅使用
- 第11-20次：✅ 继续使用（只要不在同一小时内超过10次）
- 第21次：❌ "您今日的请求次数已用完，请X小时后再试"

### 恶意用户
- 尝试分散刷接口：❌ 每日20次硬上限
- 尝试短时爆刷：❌ 每小时10次限制
- 尝试换IP：✅ 可行，但成本大增（需要大量IP资源）

## 部署说明

1. 代码已更新并推送到GitHub
2. Vercel会自动部署
3. 无需额外配置（使用默认值）
4. 如需调整，在Vercel环境变量中设置

## 调整建议

**如果用户反馈太严**：
- 提高每日限制：`MAX_REQUESTS_PER_DAY=30`
- 小时限制保持10次

**如果发现滥用**：
- 降低每日限制：`MAX_REQUESTS_PER_DAY=10`
- 降低小时限制：`MAX_REQUESTS_PER_HOUR=5`

---

**结论**: 双层限流将潜在滥用量从240次/天降至20次/天，成本风险降低92%，同时不影响正常用户体验！🎉
